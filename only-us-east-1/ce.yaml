AWSTemplateFormatVersion: "2010-09-09"

Description: Template generated by rain

Parameters:
  LinkedAccountIds:
    Type: CommaDelimitedList
    ConstraintDescription: '[0-9,]+'

  EmailAddress:
    Type: String

  OptionalSNSTopic:
    Type: String
    Default: ""

Conditions:
  UseSNS: !Not [!Equals [!Ref OptionalSNSTopic, ""]]

Transform: AWS::LanguageExtensions

Resources:
  CEAnomalyMonitorDimentional:
    Type: AWS::CE::AnomalyMonitor
    Properties:
      MonitorDimension: SERVICE
      MonitorName: example-monitor-dimentional
      MonitorType: DIMENSIONAL
      # ResourceTags:
      #   - Key: CHANGEME
      #     Value: CHANGEME

  CEAnomalyMonitorCustomLinkedAccount:
    Type: AWS::CE::AnomalyMonitor
    Properties:
      MonitorName: example-monitor-custom-linked-account
      MonitorSpecification:
        Fn::ToJsonString:
          Dimensions:
            Key: LINKED_ACCOUNT
            Values: !Ref LinkedAccountIds
      MonitorType: CUSTOM
      # ResourceTags:
      #   - Key: CHANGEME
      #     Value: CHANGEME

  # CEAnomalyMonitorCustomCostCategories:


  # CEAnomalyMonitorCustomCostAllocationTags:

  CEAnomalySubscription:
    Type: AWS::CE::AnomalySubscription
    Properties:
      Frequency: DAILY
      MonitorArnList:
        - !Ref CEAnomalyMonitorDimentional
      # ResourceTags:
      #   - Key: CHANGEME
      #     Value: CHANGEME
      Subscribers:
        - Address: !Ref EmailAddress
          Status: CONFIRMED
          Type: EMAIL
        - !If
          - UseSNS
          - Address: !Ref OptionalSNSTopic
            Status: CONFIRMED
            Type: SNS
          - !Ref AWS::NoValue
      SubscriptionName: default
      ThresholdExpression:
        Fn::ToJsonString:
          Dimensions:
            Key: ANOMALY_TOTAL_IMPACT_ABSOLUTE
            MatchOptions:
              - GREATER_THAN_OR_EQUAL
            Values:
              - "50"
