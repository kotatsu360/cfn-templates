AWSTemplateFormatVersion: "2010-09-09"

Description: Template generated by rain

Parameters:
  HomeRegion:
    Type: String
    AllowedValues:
      - us-east-2
      - us-east-1
      - us-west-1
      - us-west-2
      - af-south-1
      - ap-east-1
      - ap-southeast-3
      - ap-south-1
      - ap-northeast-3
      - ap-northeast-2
      - ap-southeast-1
      - ap-southeast-2
      - ap-northeast-1
      - ca-central-1
      - eu-central-1
      - eu-west-1
      - eu-west-2
      - eu-south-1
      - eu-west-3
      - eu-north-1
      - me-south-1
      - me-central-1
      - sa-east-1

  S3BucketName:
    Type: String

  SnsTopicARN:
    Type: String

  KmsKeyArn:
    Type: String
    Default: 'null'

  OrgId:
    Type: String
    MinLength: 12
    MaxLength: 12
    ConstraintDescription: o-[a-z0-9]+

Conditions:
  IsHomeRegionOfControlTower: !Equals [!Ref 'AWS::Region', !Ref HomeRegion]

  IsAllowedRegionByControlTower:
    - !Equals [!Ref 'AWS::Region', !Ref HomeRegion]

    # !Or
    # - !Equals [!Ref 'AWS::Region', !Ref HomeRegion]
    # - !Equals [!Ref AWS::Region, 'us-east-1']
    # - !Equals [!Ref AWS::Region, '']
    # - !Equals [!Ref AWS::Region, '']

  hasKmsKeyArn: !Not [!Equals [!Ref KmsKeyArn, 'null']]
Resources:
  ConfigConfigurationRecorder:
    Type: AWS::Config::ConfigurationRecorder
    Properties:
      RecordingGroup:
        AllSupported: true
        IncludeGlobalResourceTypes: !If
          - IsHomeRegionOfControlTower
          - true
          - false
      RoleARN: !Sub 'arn:aws:iam::${AWS::AccountId}:role/aws-service-role/config.amazonaws.com/AWSServiceRoleForConfig'

  ConfigDeliveryChannel:
    Type: AWS::Config::DeliveryChannel
    Properties:
      ConfigSnapshotDeliveryProperties:
        DeliveryFrequency: TwentyFour_Hours
      S3BucketName: !Ref S3BucketName
      S3KeyPrefix: !Ref OrgId
      S3KmsKeyArn: !If
        - hasKmsKeyArn
        - !Ref KmsKeyArn
        - !Ref AWS::NoValue
      SnsTopicARN: !If
        - IsAllowedRegionByControlTower
        - !Ref SnsTopicARN
        - !Ref AWS::NoValue
